coping with networked residences coping with the impact of networked residences at the university of waterloo 2001-12-14 overview it is essential to understand why the institution exists. that understanding provides the yardstick by which to measure all things that are possible, in order to avoid those that do not serve the purpose of the institution. uw's mission is to advance learning and knowledge through teaching, research, and scholarship. uw is not an internet service provider. an isp is an organization whose mission is to provide internet connectivity to other entities. uw does not provide internet connectivity to non-uw entities. uw's computing and network resources are provided so that uw students, faculty, and staff can pursue their respective activities in support of uw's mission, as per policy 66 and the statement on use of uw computing and network resources. extending the campus network into the uw and federated/affiliated college residences was one of the responses to uw's 1998 objective of enabling high-speed connectivity from the campus network into the homes of uw students, faculty, and staff (see the teaching and learning section of the 1998 directions statement published by ucist). the campus network and its external connections are resources that must be shared and used appropriately by uw's community of 25,000 students, faculty, and staff. in the absence of unlimited bandwidth at zero cost, every member of the uw community has a responsibility to participate in managing utilization of these shared resources to ensure that use that is not related to uw's mission does not impact on the availability of a resource for use that is, and any need to increase the capacity of a resource is due to the growth of mission-relevant use. history of modifications since the introduction of resnet in the fall term of 1997, ist has been pursuing mechanisms to cope with the impact of the growing number of network connections in the campus residences by placing per-resident limits on volume, rather than trying to constrain access based on issues such as "content". 1998-01-01introduced per-day and term-to-date limits on external traffic, to deal with excessive use of uw's external bandwidth. 2000-08-25changed from limits on external traffic to limits on campus+external traffic, to address excessive-use problems caused by residents using on-campus systems as tunnels for off-campus traffic. the term-to-date average was increased from 25mb to 30mb to account for the inclusion of on-campus traffic. 2000-12-05changed consequence of exceeding the daily maximum from confinement to the local residence network for the rest of the day to placement in a constrained-bandwidth queue for the rest of the day. 2001-01-02those who exceed a limit are placed in the constrained-bandwidth queue only during peak-hours periods, to minimize their impact on the work of the majority of the uw community but enable the transmission of larger-volume objects outside the peak-hours period. 2001-02-08introduced "1500mb in the last 10 days" limit to deal with the very small minority whose use outside the peak-hours periods had become so conspicuous that it required action before it grew to have any larger impact on the other members of the uw community who prefer to work at those times. 2001-04-24the term-to-date (3000mb) and daily-average (30mb) limits were replaced by a "300mb in the last 10 days" limit. 2001-06-25activated minimum guaranteed bandwidth fair-share queuing. 2001-09-01the residence administrations provided funding to increase uw's external bandwidth by 20%, thus raising resnet's minimum guaranteed share from 22% of 20mbps to 35% of 24mbps for the fall 2001 term. 2001-10-07after having had sufficient time to confirm that cb-wfq/wred was indeed having the expected effect, the "300mb in last 10 days" and "1500mb in last 10 days" limits were increased by 43% by changing to "mb in last 7 days", and the hours of constraint for exceeding the 300mb limit were reduced by 13%, from a total of 102 hours per week to a total of 89 hours per week (an increase of 20% in the number of non-constraint hours). 2001-11-23the "300mb in last 7 days" limit was increased by 67% to "500mb in last 7 days", an increase of 138% since the start of the term. the technology topology each residence-room outlet in the campus network is connected via cat5 utp to a 10mbps port in a stack of two or three cisco catalyst 1900 ethernet switches that are locally interconnected via 100mbps utp ports. each switch stack has a 100mbps fibre uplink to a residence-centric catalyst 5505 switch, which has a 100mbps fibre uplink to a c5505 core switch. each residence-centric c5505 contains a route switch module (ie, a router). address administration we configure the switch ports to allow only one ethernet address, and to learn and "lock in" first ethernet address seen on the port. we permanently assign an ip address corresponding to each residence-room switch port. we use dhcp to map the ethernet address to the assigned ip address. we configure each residence router to run with a static arp table of ip/ethernet addresses. when we started in the fall term of 1997, each residence administration had to collect and report to us each resident's ethernet address, by switch/port, at the start of the term. for the start of the fall term of 2000, we developed a perl program that uses snmp to get the ethernet address connected to each switch port and generate the dhcp entries and the routers' arp-table entries from that. traffic analysis we use the ip accounting feature in cisco's ios to gather traffic data (source ip, destination ip, packets, bytes) from the router that connects the residence network to the campus. we process that data via various perl programs to track and report campus+external use by each resident. the impact fall 1997 we added the first 680 ports in v1, one of the residences administered by the uw housing department. the cost to housing for the cabling plus switches was about $290 per residence-room connection. housing charged $50 per four-month term, if the resident wanted the connection activated. the "take" rate was about 50%. we activated the service in october. by november, consumption of uw's external bandwidth had more than doubled. winter 1998 we began an process of informing the residence administration each time a resident showed up in the daily "top hogs" list of those causing more than 1% of the total consumption of the external link. the residence administration contacted and warned the resident. on the third instance, we added an access-list filter in the residence router to block off-campus traffic to/from the resident's ip address ("confined to campus"). to get the confinement removed, the resident had to go plead with the associate dean of computing for the faculty in which the resident was registered as a student. once the adc got annoyed of excuses and said "no", the resident's connection remained confined to campus for the rest of the term. the process greatly annoyed the small minority of students who felt no obligation to confine their use to university-intended purposes. the process also greatly annoyed the adcs, the residence administration, and us. we began to contemplate ways to automate the process. and, some small number of enterprising residents quitely began to use one faculty's http proxy server to "tunnel" their off-campus traffic. fall 1998 the number of residence connections increased from 680 to 1500. the annoying aspects of the process got much more annoying. we started implementation for a fully-automated system of limits, by adding a few more perl programs to the suite. winter 1999 we instituted the automated system of limits ... max 2500mb per term, max 25mb term-to-date daily average, and max 150mb per day. data showed that 85% of the residents were under those limits. exceeding the max-per-day limit resulted in confinement to campus for the rest of the day. exceeding the term-to-date daily average lowered the max-per-day limit to 15mb for as long as it took the daily average to fall below 25mb again. exceeding the term limit lowered the max-per-day limit for the rest of the term. ip accounting data collected, analyzed, updated every 12 minutes. no more annoyances to adcs, residence administrators, or us. the portion of external traffic attributable to residence connections fell to 20%. we started to get complaints from some good-citizen residents about the bad-citizen residents who were using the unrestricted on-campus http proxy server to "tunnel" their off-campus downloads. fall 1999 residence connections went from 1500 to 1800. the "take" rate went up to about 65%. winter 2000 the "take" rate was up to about 70%. the prominence of napster exposed the fact that lots of bad-citizen residents were using the unrestricted on-campus http proxy server to "tunnel" their off-campus traffic. our first venture in to qos mechanisms was an experiment with the cisco ios "committed access rate" (car) to constrain residence traffic to 2mbps. brutally effective. we want a kinder gentler mechanism that only attacks those who are trying to consume the most. we started doing ip accounting at the residence routers and tracking the total on-campus and external traffic by resident. total external use caused by residents, as a result of "tunneling" through on-campus systems, was almost four times that detected at the external router ... approaching 60% of the external traffic. the faculty that owned the proxy server asked us to prevent its use from residence connections. total traffic attributable to the residence connections immediately dropped, to only about twice what was being detected at the external router (ie, some residents were using other tunneling targets and techniques). spring 2000 an external-traffic report in the middle of the term ... 2000-06-21 residence external traffic average 12 mbpd, 808 users, 51 days mbpd n cumn cum%n cum%v ambpd ----- ---- ---------- ------- ------- ----- <5 201 201 607 24 76 2 98 1 < 10 139 340 468 42 58 12 88 3 < 15 130 470 338 58 42 28 72 6 < 20 136 606 202 75 25 52 48 8 < 25 135 741 67 91 9 82 18 11 < 30 66 807 1 99 1 99 1 12 < 35 1 808 0 100 0 99 1 12 we redid the automated system to limit campus+external per-resident traffic, for implementation starting fall 2000. 3000mb per term, max 30mb term-to-date daily average. again, based on data that showed that 85% of the residents used less than that. 2000-06-21 residence campus+external traffic 21gb/day, 715 users, average 30mb/day mbpd n cumn cum%n cum%v ambpd ----- ---- ---------- ------- ------- ----- <5 85 85 630 11 89 0 100 2 < 10 103 188 527 26 74 4 96 5 < 15 109 297 418 41 59 11 89 7 < 20 116 413 302 57 43 20 80 10 < 25 113 526 189 73 27 32 68 13 < 30 89 615 100 86 14 44 56 15 <=== < 35 25 640 75 89 11 47 53 15 < 40 9 649 66 90 10 49 51 16 < 45 9 658 57 92 8 51 49 16 < 50 5 663 52 92 8 52 48 16> 50 52 715 0 100 0 100 0 29 a number of academic units are preparing to experiment with instructional video-on-demand distribution servers. the new system of residence-traffic limiting therefore has a list of on-campus ip addresses that are exempt from counted traffic. we developed a set of web-based tools by which the residence administrator can (after authenticating) query a resident's usage counters and display/alter the status of certain switch/port settings in that residence, including to clear the learned ethernet address from a port or disable/enable the port. it is a few perl programs that do snmp "get" and "set" operations. (it has also been expanded into a more general-purpose tool that will enable specific individuals to display and alter various port parameters on various switches.) one of these programs allows the residence-network administrator to automatically clear all the learned ethernet addresses from all the residence switches at the end of each term, so that the switches will acquire the newly-learned ethernet addresses at the the beginning of next term. fall 2000 -- constrain, not confine residence connections went from 1800 to 2400 ... that's the half-way point for the existing plus currently-planned new residences. the "subscription rate" was 2010, or 84%. as of the end of the fall-term lecture period on december 4, 94% of the residents were under the 30mb daily-average limit, 45% had never exceeded their daily-max limit, and another 46% had been in a limit-exceeded state less than 5% of the time, total time confined was 1.5% of user-days total, and on-campus traffic was 5.3% of campus+external total. on december 5, we began putting those residents who have exceeded their limit for the day into contention for a constrained low-bandwidth pipe (64kbps) between the residence router and the campus for the rest of that day, rather than cutting off their entire campus+external access for the rest of that day. that bandwidth is sufficient only to allow them to continue with small text-based applications such as reading/sending mail, reading/posting course newsgroups, and retrieving assignment details from course webservers. over the course of a day, as the number of users in contention grows, being constrained becomes less and less pleasant. winter 2001 -- "last 10 days" limits at the start of the term, we began applying the constraint only during "peak hours" periods, which we defined as 0800-2300 monday through thursday, 0800-1800 friday, 1200-1800 saturday, and 1200-2300 sunday. traffic is counted throughout the entire day, but the consequence of being in the limit-exceeded state is applied only during the peak-hours periods. outside those periods, usage is not limited. it took less than five weeks for a very small minority (2%) of the residents to prove that they were capable of consuming all available external bandwidth outside the peak-hours periods. to curtail this "conspicuous consumption" before the very small minority grew any larger, we introduced a last-10-days limit of 1500mb and put those who exceeded it into the constrained-bandwidth queue even outside the peak-hours periods. at the end of the term, we replaced the "3000mb since start of term" and "30mb daily average" limits with a "300mb in last 10 days" limit. spring 2001 -- qos considerations starting 2001-06-25, we activated class-based weighted fair queuing with weighted random early detection on the external-links router, to provide "guaranteed minimum bandwidth" for the residence networks and the rest of the campus, based on the percent that the resnet users represent of the entire campus. but we are keeping the per-resident limits and constraints in place until we are confident that we understand the extent to which cbwfq/wred is effective. fall 2001 -- guaranteed minimum bandwidth effective 2001-09-01, the residence administrations provided funding to increase uw's external bandwidth by 20%, thus raising resnet's minimum guaranteed share from 22% of 20mbps to 35% of 24mbps for the fall 2001 term. on 2001-10-07, after having had sufficient time to confirm that cb-wfq/wred was indeed having the expected effect, the limits were increased by changing the last-n-days period from 10 to 7, and the hours of constraint for exceeding the 300mb limit were reduced by. on 2001-11-23, the "300mb in last 7 days" limit was increased to "500mb in last 7 days". the cb-wfq/wred algorithms have proven very effective during weekday hours, as shown by the following daily-summary report. 2001-12-06 resnet consumption of external bandwidth ip general-internet plus university/ca*net3 capacity averages 20.6mbps * one or both links are usually saturated if ext reaches 15.6mbps hour ext %cap resext %cap %ext guarmin = 35% of ext at capacity ---- ---- ---- ------ ---- ---- 00 14.8 72 12.5 61 84 ---------+-----c-----e---- * 01 19.4 94 17.3 84 89 ---------+-----------ce--- * 02 18.5 90 16.1 78 87 ---------+----------c-e--- 03 13.1 64 10.9 53 83 ---------+---c-------e---- 04 10.9 53 9.3 45 85 ---------+-c---------e---- 05 9.0 44 7.4 36 82 ---------c----------e----- 06 6.6 32 4.2 20 64 -----c---+------e--------- 07 5.5 27 3.7 18 67 ----c----+-------e-------- 08 10.0 48 5.5 27 55 -------c-+----e----------- 09 12.8 62 3.6 17 28 ----c--e-+---------------- 10 14.7 71 5.5 27 37 -------c-e---------------- * 11 16.3 79 6.1 30 37 --------ce---------------- * 12 18.0 87 7.4 36 41 ---------ce--------------- * 13 17.9 87 7.6 37 42 ---------ce--------------- * 14 17.9 87 7.7 37 43 ---------c-e-------------- * 15 17.5 85 7.4 36 42 ---------ce--------------- * 16 16.9 82 6.6 32 39 --------c+e--------------- * 17 17.7 86 7.2 35 41 ---------ce--------------- * 18 16.9 82 10.4 50 62 ---------+--c---e--------- * 19 16.0 78 10.6 51 66 ---------+---c--e--------- * 20 16.2 79 11.2 54 69 ---------+----c--e-------- * 21 17.0 82 12.1 59 71 ---------+-----c--e------- * 22 18.4 89 13.8 67 75 ---------+-------c-e------ * 23 18.1 88 14.1 68 78 ---------+-------c--e----- winter 2002 -- ??? resource-management alternatives alternatives considered and rejected the following do not enable alternate means of connecting computers in residences to the campus network. however, achieving the bandwidth-control objective they represent is a necessary prior condition to pursuing alternate means of connection. provide residence connectivity via some isp. this would require obtaining non-uw ip network numbers for the residence networks. it has the advantage of removing 95% of residence traffic from contention for uw resources, but it also has several significant disadvantages. it is not likely to be a wise use of money ... provisioning for the required bandwidth (bell via hse, rogers via @home, or some other internet service provider with a kw presence) will be more expensive per total mbps than the significant discount that onet networking obtains for its toronto general-internet connections to its national/international isps because the aggregate general-internet subscribed bandwidth of onet's members is measured in the hundreds of mbps. also, for the 5% of residence traffic that is with on-campus systems, unless that isp is willing to provide a direct local connection of its network to the uw network, this will cause routing of campus/residence packets through an added chain of local/regional/national isps; the resulting packet latency and discard rates will be worse by factors measured in tens to a hundred. this goes in the exact opposite direction to preparing for an environment in which connectivity with on-campus systems will increase as the web-interface student information system unfolds over the next year and higher-bandwidth "teaching and learning" multi-media servers and services are developed. route the external residence traffic through an isp and the uw traffic via the campus network. this would also require obtaining non-uw ip network numbers for the residence networks. it does not address the higher cost of the isp external bandwidth. also, it perpetuates the existing complexity to deal with residents using on-campus systems to tunnel their off-campus traffic. provide separate onet external bandwidth for resnet users. for the immediate future only, it is possible to do this over the atm circuits used by onet networking, but there are significant disadvantages ... unused capacity in the resnet-dedicated circuit would not be available to the rest of the campus, unused capacity in the non-resnet circuit would not be available to resnet users, it does not eliminate the "tunnel through on-campus systems" problem, and the atm connection to onet will be abandoned in favour of a gigabit ethernet connection to the orion "optical ip" network that will replace the onet network sometime in 2002. impose a maximum-bandwidth cap on onet external bandwidth for resnet users. this is a variation of "provide separate onet bandwidth" above. it has the same disadvantage that unused non-resnet capacity would not be available to resnet users, and it does not eliminate the "tunnel" problem. the alternative chosen to reduce the complexity of meeting resource-management obligations, an approach is required that involves ip bandwidth allocation, fair-share queuing, and packet-priorization mechanisms. these are collectively referred to as ip "quality of service" (qos) mechanisms. this does not eliminate the "tunnel" problem, but it is the best approach to the rest of the problems. provide a guaranteed minimum onet external bandwidth for resnet users. this can be done using ip bandwidth-apportioning features of the uw router and the onet router at the waterloo and toronto ends of uw's onet link. the approach is to set a basic minimum guarantee equal to the percent that resnet users represent of the total uw population. it is possible for the residence administrations to provide ist with funds for additional bandwidth to increase the resnet guaranteed minimum. it is necessary to maintain essential aspects of the current limits mechanism, to address the "tunnel through on-campus systems" problem and to constrain unreasonably excessive use. the end ... not identification and authentication mechanisms uw's on-line campus directory, uwdir, has been in place since the early 1990s. in 1999, we augmented this identification system with a userid/password authentication system using a windows nt domain controller database. in 2000, we developed a network-port authentication mechanism that uses the campus-directory authentication system. this enables us to deploy network ports for portable or desktop computers, anywhere on campus ("we can even wire the trees"). it also permits the resident with a portable computer to use one of those connections, and still enables us to apply the per-resident limits to that resident. perhaps we'll abandon the residence address-assignment process in favour of the port-authentication process, if we can modify the system of per-resident limits to be keyed by userid rather than ip address. references the campus network mrtg graphs of traffic on the residence-network router interfaces uw residence-network directions roger watt, ist.